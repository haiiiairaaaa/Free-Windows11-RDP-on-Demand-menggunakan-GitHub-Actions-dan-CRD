name: Ultra Stable RDP (Optimized Debian Host)

on:
  workflow_dispatch:
    inputs:
      crd_full_command:
        description: 'Paste full command from CRD Headless setup (CMD/PowerShell)'
        required: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 10080
    env:
      INSTALLER_CACHE_PATH: C:\cached-installers

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üß© Prepare Environment
        shell: pwsh
        run: |
          New-Item -Path C:\Workspace -ItemType Directory -Force | Out-Null
          if (-not (Test-Path "${{ env.INSTALLER_CACHE_PATH }}")) {
            New-Item -Path "${{ env.INSTALLER_CACHE_PATH }}" -ItemType Directory -Force | Out-Null
          }
          Write-Host "‚úÖ Workspace prepared successfully."

      - name: ‚öôÔ∏è Install Required Software
        shell: pwsh
        run: |
          Write-Host "Installing VirtualBox and Chrome Remote Desktop..."
          $vboxPath = Join-Path "${{ env.INSTALLER_CACHE_PATH }}" "vbox_installer.exe"
          $crdPath = Join-Path "${{ env.INSTALLER_CACHE_PATH }}" "crd.msi"

          if (-not (Test-Path $vboxPath)) {
            Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.0.18/VirtualBox-7.0.18-162988-Win.exe" -OutFile $vboxPath
          }
          Start-Process -FilePath $vboxPath -ArgumentList '--silent --ignore-reboot' -Wait

          if (-not (Test-Path $crdPath)) {
            Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $crdPath
          }
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i `"$crdPath`" /qn /norestart" -Wait
          Start-Sleep -Seconds 15

      - name: üöÄ Apply Full Performance Tweaks
        shell: pwsh
        run: |
          Write-Host "Applying aggressive performance and network optimizations..."

          # Power Plan
          powercfg -duplicatescheme e9a42b02-d5df-448d-aa00-03f14749eb61 | Out-Null
          powercfg /s e9a42b02-d5df-448d-aa00-03f14749eb61 | Out-Null

          # Disable Services that cause lag
          $services = "WSearch","SysMain","wuauserv","BITS","DiagTrack"
          foreach ($s in $services) {
            Get-Service -Name $s -ErrorAction SilentlyContinue | ForEach-Object {
              Stop-Service $_ -Force -ErrorAction SilentlyContinue
              Set-Service $_ -StartupType Disabled -ErrorAction SilentlyContinue
            }
          }

          # Disable Visual Effects
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFxSetting /t REG_DWORD /d 2 /f
          reg add "HKCU\Control Panel\Desktop" /v UserPreferencesMask /t REG_BINARY /d 9012078010000000 /f

          # Optimize TCP & network stack
          netsh int tcp set global autotuninglevel=highlyrestricted
          netsh int tcp set global chimney=enabled
          netsh int tcp set global rss=enabled
          netsh interface tcp set heuristics disabled

          # Disable sleep / hibernate
          powercfg -change -standby-timeout-ac 0
          powercfg -change -hibernate-timeout-ac 0
          powercfg -h off

          # Set CRD and VBox to high CPU priority
          reg add "HKLM\SYSTEM\CurrentControlSet\Control\PriorityControl" /v Win32PrioritySeparation /t REG_DWORD /d 26 /f

          Write-Host "‚úÖ System optimized for maximum RDP stability and throughput."

      - name: üíª Launch Chrome Remote Desktop
        shell: pwsh
        run: |
          $FullCommand = '${{ github.event.inputs.crd_full_command }}'
          $ArgsPattern = '\s+--code.+'
          if ($FullCommand -match $ArgsPattern) { $crdArgs = $matches[0].Trim() }
          else { Write-Error "Could not extract CRD arguments."; exit 1 }

          $crdExe = Get-ChildItem -Path "C:\Program Files","C:\Program Files (x86)" -Recurse -Filter "remoting_start_host.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $crdExe) { Write-Error "CRD executable not found!"; exit 1 }

          $PIN = "123456"
          $finalArgs = "$crdArgs -pin=`"$PIN`""

          Write-Host "Starting CRD Host..."
          Start-Process -FilePath $crdExe.FullName -ArgumentList $finalArgs -Priority High

          Start-Sleep -Seconds 10
          Write-Host "CRD is now running with optimized settings."

      - name: üïì Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "----------------------------------------"
          Write-Host "Windows User : runneradmin"
          Write-Host "CRD PIN       : 123456"
          Write-Host "----------------------------------------"
          Write-Host "Keeping runner alive for 7 days..."
          while ($true) {
            Write-Host "Still alive at $(Get-Date)"
            Start-Sleep -Seconds 600
          }

      - name: üßπ Final Cleanup
        if: always()
        shell: pwsh
        run: |
          Write-Host "Cleaning up environment..."
          Stop-Process -Name "remoting_*","chrome-remote-desktop" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path C:\Workspace -Recurse -Force -ErrorAction SilentlyContinue
          powercfg /s 381b4222-f694-41f0-9685-ff5bb260df2e | Out-Null
          Write-Host "Cleanup done."
