name: Windows CRD Headless (Final Stable)

on:
  workflow_dispatch:
    inputs:
      crd_full_command:
        description: 'Salin dan tempel SELURUH perintah dari halaman CRD Headless (CMD atau PowerShell)'
        required: true

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 10080 # maksimum 7 hari
    env:
      INSTALLER_CACHE_PATH: C:\cached-installers

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: üß© Prepare Environment & Install Software
        shell: pwsh
        run: |
          Write-Host "Preparing workspace and installing required software..."
          New-Item -Path C:\Workspace -ItemType Directory -Force | Out-Null
          if (-not (Test-Path "${{ env.INSTALLER_CACHE_PATH }}")) {
            New-Item -Path "${{ env.INSTALLER_CACHE_PATH }}" -ItemType Directory -Force | Out-Null
          }

          $vboxPath = Join-Path "${{ env.INSTALLER_CACHE_PATH }}" "virtualbox_installer.exe"
          $crdPath  = Join-Path "${{ env.INSTALLER_CACHE_PATH }}" "crd.msi"

          if (-not (Test-Path $vboxPath)) {
            Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.0.18/VirtualBox-7.0.18-162988-Win.exe" -OutFile $vboxPath
          }
          Start-Process -FilePath $vboxPath -ArgumentList '--silent --ignore-reboot' -Wait

          if (-not (Test-Path $crdPath)) {
            Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile $crdPath
          }
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i `"$crdPath`" /qn /norestart" -Wait

          Write-Host "Waiting for CRD installation to finalize..."
          Start-Sleep -Seconds 15

      - name: ‚öôÔ∏è Apply System Optimizations
        shell: pwsh
        run: |
          Write-Host "Applying system optimizations for smoother performance..."
          try { powercfg /s SCHEME_MIN } catch { Write-Warning "Power plan tweak failed: $_" }
          reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\VisualEffects" /v VisualFxSetting /t REG_DWORD /d 2 /f | Out-Null
          foreach ($svc in @("WSearch","SysMain","wuauserv","BITS","DiagTrack")) {
            Get-Service -Name $svc -ErrorAction SilentlyContinue | ForEach-Object {
              Stop-Service $_ -Force -ErrorAction SilentlyContinue
              Set-Service $_ -StartupType Disabled -ErrorAction SilentlyContinue
            }
          }
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global rss=enabled
          netsh int tcp set global rsc=enabled
          netsh int tcp set global ecncapability=disabled
          netsh int tcp set global timestamps=disabled
          netsh int tcp set global pacingprofile=always
          Write-Host "‚úÖ Optimizations applied successfully!"

      - name: üöÄ Start Chrome Remote Desktop (Headless)
        shell: pwsh
        run: |
          Write-Host "Starting Chrome Remote Desktop in headless mode..."

          # Ambil input user dan ekstrak argumen penting
          $FullCommand = '${{ github.event.inputs.crd_full_command }}'
          $ArgsPattern = '\s+--code.+'  
          if ($FullCommand -match $ArgsPattern) {  
              $crdArgs = $matches[0].Trim()  
          } else {  
              Write-Error "‚ùå Tidak dapat mengekstrak argumen CRD. Pastikan kamu menempelkan seluruh perintah dari halaman headless!"  
              exit 1  
          }  

          # Cari file eksekusi CRD
          $searchPaths = @( "C:\Program Files\Google", "C:\Program Files (x86)\Google" )  
          $crdExePath = $null  
          foreach ($path in $searchPaths) {  
              if (Test-Path $path) {  
                  $foundFile = Get-ChildItem -Path $path -Filter "remoting_start_host.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1  
                  if ($null -ne $foundFile) {  
                      $crdExePath = $foundFile.FullName  
                      break  
                  }  
              }  
          }  

          if (-not $crdExePath) {  
              Write-Error "FATAL: remoting_start_host.exe not found after installation."  
              exit 1  
          }  
          Write-Host "Found CRD executable at: $crdExePath"

          # Jalankan CRD Host
          $PIN = "123456"
          $finalArgs = "$crdArgs --pin=$PIN"
          Write-Host "Launching CRD Host..."
          Start-Process -FilePath $crdExePath -ArgumentList $finalArgs
          Start-Sleep -Seconds 10
          Write-Host "‚úÖ CRD host started successfully."

      - name: üïì Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "----------------------------------------"
          Write-Host "Windows User : runneradmin"
          Write-Host "CRD PIN       : 123456"
          Write-Host "----------------------------------------"
          Write-Host "Keeping runner alive for 7 days..."
          Start-Sleep -Seconds 604800

      - name: üßπ Cleanup on Exit
        if: always()
        shell: pwsh
        run: |
          Write-Host "--- Running Cleanup ---"
          Stop-Process -Name "remoting_*","chrome-remote-desktop" -Force -ErrorAction SilentlyContinue
          Remove-Item -Path C:\Workspace -Recurse -Force -ErrorAction SilentlyContinue
          powercfg /s 381b4222-f694-41f0-9685-ff5bb260df2e | Out-Null
          foreach ($svc in @("WSearch","wuauserv")) {
            Set-Service -Name $svc -StartupType Automatic -ErrorAction SilentlyContinue
            Start-Service -Name $svc -ErrorAction SilentlyContinue
          }
          Write-Host "--- Cleanup complete ---"
